{% extends "base.html" %}
{% block title %}Play Connect4{% endblock %}

{% block content %}
<h1>It's play time</h1>
<script>
    var x_offset = -3
    var y_offset = -2

    var aspect_ratio = window.innerWidth / window.innerHeight
    var scene = new THREE.Scene();
    var camera = new THREE.PerspectiveCamera( 80, aspect_ratio, 0.1, 1000 );
    var raycaster = new THREE.Raycaster();
    var mouse = new THREE.Vector2();

    var light = new THREE.AmbientLight( 0x808080 ); 
    scene.add( light )

    var directionalLight = new THREE.DirectionalLight( 0xffffff, 0.6 );
    directionalLight.position.set( 0, 1, 0 );
    scene.add( directionalLight );

    var pointLight = new THREE.PointLight( 0xffffff, 1.5 );
    pointLight.position.set( 0, 100, 90 );
    scene.add( pointLight );

    var renderer = new THREE.WebGLRenderer({ alpha: true });
    renderer.setSize( window.innerWidth, window.innerHeight );
    document.body.appendChild( renderer.domElement );

    camera.position.z = 5;

    for ( i = 0; i < 7; i++ ) {
        x = i + x_offset;
        var column_geo = new THREE.BoxGeometry( 1, 6, 0.2, 1, 6 );
        var column_mat = new THREE.MeshPhongMaterial( {
            color: 0x0000ff,
            wireframe: true,
            wireframeLinewidth: 2
            });
        var frame_column = new THREE.Mesh( column_geo, column_mat )
        frame_column.position.x = x
        frame_column.position.y = 0.5
        frame_column.column = i
        scene.add(frame_column)
    }

    function position_coin(x, y, coin) {
        coin.position.x = x + x_offset;
        coin.position.y = y + y_offset;
    }

    function make_coin(player) {
        var colour
        if (player) {
            color = 0xff0000
        } else {
            color = 0xffff00
        }
        var geometry = new THREE.CylinderGeometry( 0.45, 0.45, 0.1, 32);
        var material = new THREE.MeshPhongMaterial( { color: color, shininess: 100 } );
        var coin = new THREE.Mesh( geometry, material );
        scene.add( coin );
        coin.rotateX(0.5 * Math.PI);
        return coin;
    }

    var board = [[],[],[],[],[],[],[]]

    function add_coin(column, player) {
        coin = make_coin(player);
        board[column].push(player);
        x = column;
        y = board[column].length - 1;
        position_coin( x, y, coin );
    }

    function add_moves(moves) {
        for ( var i = 0; i < moves.length; i++ ) {
            player = i % 2;
            add_coin(moves[i], player)
        }
    }

    add_moves([0,0,0,1,2,2,3,4,5,3,2,3,2,0,0,0])

    function onMouseMove( event ) {
        event.preventDefault()
        mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
        mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
    }

    function onMouseClick( event ) {
        event.preventDefault()
        mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
        mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
        raycaster.setFromCamera( mouse, camera, 0, 1 );
        var intersects = raycaster.intersectObjects( scene.children );
        if (intersects.length > 0) {
            add_coin(intersects[0].object.column, true);
        }
    }

    var intersected;
    var render = function () {
        requestAnimationFrame( render );
        // HACK! if mouse is exactly at 0,0 assume it is acutally off screen
        if ( mouse.x != 0 && mouse.y != 0 ) {
            raycaster.setFromCamera( mouse, camera, 0, 1 );
            var intersects = raycaster.intersectObjects( scene.children );
            if (intersects.length > 0) {
                if ( intersected != intersects[ 0 ].object ) {
                    if ( intersected ) {
                        intersected.material.color.set(intersected.currentColor);
                    }
                    intersected = intersects[ 0 ].object;
                    intersected.currentColor = intersected.material.color.getHex();
                    intersected.material.color.set( 0xff0000 );
                }
                console.log(mouse);
                console.log(intersects[ 0 ].object);
            } else {
                if ( intersected ) {
                    intersected.material.color.set(intersected.currentColor);
                }
                intersected = null
            }
        }
        renderer.render( scene, camera );
    };

    window.addEventListener( 'mousemove', onMouseMove, false );
    window.addEventListener( 'mousedown', onMouseClick, false );
    render();
</script>
{% endblock %}
